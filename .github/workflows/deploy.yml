name: Авто-деплой на сервера
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - name: основной
            host: ${{ secrets.HOST_BASED }}
            key:  ${{ secrets.SSH_KEY_BASED }}
          - name: резервный
            host: ${{ secrets.HOST_RESERVE }}
            key:  ${{ secrets.SSH_KEY_RESERVE }}
          - name: очередь
            host: ${{ secrets.HOST_QUEUE }}
            key:  ${{ secrets.SSH_KEY_QUEUE }}
          - name: воркер1-2
            host: ${{ secrets.HOST_WORKER1 }}
            key:  ${{ secrets.SSH_KEY_WORKER }}
          - name: воркер3-4
            host: ${{ secrets.HOST_WORKER2 }}
            key:  ${{ secrets.SSH_KEY_WORKER }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Deploy to ${{ matrix.name }}
      uses: appleboy/ssh-action@v0.1.8
      with:
        host:                    ${{ matrix.host }}
        username:                root
        key:                     ${{ matrix.key }}
        # отключаем жёсткую проверку known_hosts:
        use_insecure_known_hosts: true
        script: |
          cd /opt/ii-tutor-bot
          git pull origin main
          docker-compose up -d --build
